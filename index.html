<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>顶流广告技术有限公司</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:800px; margin:0 auto; padding:20px; background:#f5f5f5; }
    .container { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .input-group { margin-bottom:20px; }
    input, button { font-size:16px; padding:10px; }
    button { background:#4CAF50; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    button:hover { background:#45a049; }
    .results, .error, .loading { margin-top:20px; }
    .error { color:#f44336; }
    .loading { text-align:center; }
    .city-item { display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee; }
  </style>
</head>
<body>
  <div class="container">
    <h1>顶流广告技术有限公司</h1>
    <div class="input-group">
      <input id="addressInput" type="text" placeholder="请输入店铺地址" />
      <button id="btnSearch">点击查询</button>
      <div style="margin-top:8px;color:#666;">Ski定点查询</div>
    </div>

    <div id="loading" class="loading" style="display:none;">正在计算中...</div>
    <div id="error" class="error"></div>
    <div id="results" class="results"></div>
  </div>

  <script>
    const btn = document.getElementById('btnSearch');
    const loadingEl = document.getElementById('loading');
    const errorEl   = document.getElementById('error');
    const resultsEl = document.getElementById('results');

    // 调用 Worker 代理的地理编码接口，提取全州名小写
    async function geocodeAddress(address) {
      const url = `/api/proxy/v1/search.php?` +
                  `q=${encodeURIComponent(address)}` +
                  `&format=json&countrycodes=us&addressdetails=1`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`地理编码失败：${resp.status}`);
      const arr = await resp.json();
      if (!Array.isArray(arr) || arr.length === 0) {
        throw new Error('未找到匹配地址');
      }
      const { lat, lon, address: addr } = arr[0];
      if (!addr.state) {
        throw new Error('API 未返回州信息，无法继续');
      }
      // 使用全州名小写作为 key
      return { lat, lon, state: addr.state.toLowerCase() };
    }

    // 调用 Worker 代理的矩阵行程时间接口
    async function calculateDrivingTime(orig, dest) {
      const path = `${orig.lon},${orig.lat};${dest.lon},${dest.lat}`;
      const url = `/api/proxy/v1/matrix/driving/${path}?annotations=distance,duration`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`矩阵请求失败：${resp.status}`);
      const data = await resp.json();
      if (!data.durations?.[0]?.[1]) {
        throw new Error('API 未返回持续时间');
      }
      const minutes = Math.round(data.durations[0][1] / 60);
      const miles   = ((data.distances?.[0]?.[1] || 0) / 1609.34).toFixed(1);
      return { duration: minutes, distance: parseFloat(miles) };
    }

    // 主函数：计算距离并渲染结果
    async function calculateDistances() {
      const addr = document.getElementById('addressInput').value.trim();
      if (!addr) {
        errorEl.textContent = '请输入店铺地址';
        return;
      }
      errorEl.textContent = '';
      resultsEl.innerHTML = '';
      loadingEl.style.display = '';

      try {
        // 1. 获取店铺坐标及州
        const store = await geocodeAddress(addr);

        // 2. 加载 skipCities.json，依据州名取出城市列表
        const raw = await fetch('skipCities.json');
        const allCities = await raw.json();
        const cities = allCities[store.state] || [];
        if (!cities.length) {
          throw new Error(`未找到 "${store.state}" 州的城市数据，请检查 skipCities.json`);
        }

        // 3. 并行请求每个城市的行程时间
        const list = await Promise.all(cities.map(async city => {
          const dest = await geocodeAddress(`${city}, ${store.state}`);
          const info = await calculateDrivingTime(store, dest);
          return { city, ...info };
        }));

        // 4. 排序并显示
        list.sort((a, b) => a.distance - b.distance);
        resultsEl.innerHTML = list.map(r =>
          `<div class="city-item">
             <span>${r.city}</span>
             <span>${r.distance} 英里 / ${r.duration} 分钟</span>
             <a href="https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(addr)}&destination=${encodeURIComponent(r.city + ', ' + store.state)}" target="_blank">
               <button>导航</button>
             </a>
           </div>`
        ).join('');
      } catch (e) {
        errorEl.textContent = e.message;
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    btn.addEventListener('click', calculateDistances);
  </script>
</body>
</html>
